package gui;

import java.awt.BorderLayout;
import java.awt.Font;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.Observer;

import javax.swing.BorderFactory;
import javax.swing.ImageIcon;
import javax.swing.JButton;
import javax.swing.JFrame;
import javax.swing.JMenuBar;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTextArea;
import javax.swing.text.AbstractDocument;

import commands.Arreter;
import commands.Defaire;
import commands.Demarrer;
import commands.Refaire;
import commands.Rejouer;
import editor.Enregistreur;
import editor.GestionnaireHisto;
import editor.Observable;
import editor.Observateur;
import editor.Recorder;
import engine.Buffer;
import engine.EditionEngine;
import recordables.SupTexteEnregistrable;

/**
 * Interface graphique de notre éditeur
 * Utilise une JTextArea pour l'affichage du buffer
 */
public final class IHM extends JFrame implements Observateur, ActionListener {

	private static final long serialVersionUID = 1L;

	// buttons declaration
	private final JButton	paste;
	private final JButton	copy;
	private final JButton	cut;
	private final JButton	delete;
	private final JButton	start;
	private final JButton	replay;
	private final JButton	stop;

	private final JButton	undo;
	private final JButton	redo;

	private final JTextArea textArea;
	// Edition Engine declaration
	private final EditionEngine engine;

	// Listener on textArea
	private final ModificationFilter	modifFilter;
	private final SelectionListener		selectionListener;

	// recorder for recordable commands
	private final Recorder recorder;

	public IHM(final EditionEngine engine, final Enregistreur recorder, final GestionnaireHisto history) {

		if (engine == null)
			throw new IllegalArgumentException("Null engine");
		if (recorder == null)
			throw new IllegalArgumentException("Null recorder");
		if (history == null)
			throw new IllegalArgumentException("Null history");

		/* Traitement */
		this.engine = engine;
		this.recorder = recorder;

		modifFilter = new ModificationFilter(engine, recorder);
		selectionListener = new SelectionListener(engine, recorder);

		textArea = new TextAreaCustom(15, 80, engine, recorder);
		textArea.setBorder(BorderFactory.createEmptyBorder(2, 2, 2, 2));
		textArea.setFont(new Font("monospaced", Font.PLAIN, 14));
		textArea.addCaretListener(selectionListener);
		((AbstractDocument) textArea.getDocument()).setDocumentFilter(modifFilter);
		JScrollPane scrollingText = new JScrollPane(textArea);

		JPanel content = new JPanel();
		content.setLayout(new BorderLayout());

		content.add(scrollingText, BorderLayout.CENTER);

		//
		JMenuBar menuBar = new JMenuBar();
		menuBar.setBorder(BorderFactory.createEmptyBorder(1, 1, 1, 0));

		//
		paste = new JButton();
		copy = new JButton();
		cut = new JButton();
		delete = new JButton();

		start = new StartButton();
		replay = new ReplayButton();
		stop = new StopButton();

		recorder.addObserver((Observer) start);
		recorder.addObserver((Observer) replay);
		recorder.addObserver((Observer) stop);

		undo = new UndoButton();
		redo = new RedoButton();

		history.ajouterObservateur((Observateur) undo);
		history.ajouterObservateur((Observateur) redo);

		// Icon set
		paste.setIcon(new ImageIcon(getClass().getResource("/icones/paste.png")));
		copy.setIcon(new ImageIcon(getClass().getResource("/icones/copy.png")));
		cut.setIcon(new ImageIcon(getClass().getResource("/icones/cut.png")));
		delete.setIcon(new ImageIcon(getClass().getResource("/icones/delete.png")));
		start.setIcon(new ImageIcon(getClass().getResource("/icones/rec.png")));
		replay.setIcon(new ImageIcon(getClass().getResource("/icones/play.png")));
		stop.setIcon(new ImageIcon(getClass().getResource("/icones/stop.png")));;
		undo.setIcon(new ImageIcon(getClass().getResource("/icones/undo.png")));
		redo.setIcon(new ImageIcon(getClass().getResource("/icones/redo.png")));

		// Set bubble tips
		paste.setToolTipText("Paste");
		copy.setToolTipText("Copy");
		cut.setToolTipText("Cut");
		delete.setToolTipText("delete");
		start.setToolTipText("Rec");
		replay.setToolTipText("Replay");
		stop.setToolTipText("Stop");
		undo.setToolTipText("Undo");
		redo.setToolTipText("Redo");

		// Set listener on button
		paste.addActionListener(this);
		copy.addActionListener(this);
		cut.addActionListener(this);
		delete.addActionListener(this);
		start.addActionListener(this);
		replay.addActionListener(this);
		stop.addActionListener(this);
		undo.addActionListener(this);
		redo.addActionListener(this);

		paste.setFocusable(false);
		copy.setFocusable(false);
		cut.setFocusable(false);
		delete.setFocusable(false);
		start.setFocusable(false);
		replay.setFocusable(false);
		stop.setFocusable(false);
		undo.setFocusable(false);
		redo.setFocusable(false);

		// Add all buttons on menuBar
		menuBar.add(copy);
		menuBar.add(cut);
		menuBar.add(paste);
		menuBar.add(delete);
		menuBar.add(start);
		menuBar.add(replay);
		menuBar.add(stop);
		menuBar.add(undo);
		menuBar.add(redo);

		// disable button at the launch
		stop.setEnabled(false);
		start.setEnabled(false);

		// Set Main window
		setContentPane(content);
		setJMenuBar(menuBar);

		// Ajout des comportements par défaut et des propriété propres à
		// notre éditeur + Affichage
		setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		setTitle("Text Editor v3");
		setLocationRelativeTo(null);
		setVisible(true);
		pack();
	}

	@Override
	public final void actionPerformed(ActionEvent e) {

		if (e.getSource() == paste)
			new PasteEnregistrable(engine, recorder).executer();
		else if (e.getSource() == copy)
			new CopyEnregistrable(engine, recoder).executer();
		else if (e.getSource() == cut)
			new CutEnregistrable(engine, recoder).executer();
		else if (e.getSource() == supprimer)
			new SupTexteEnregistrable(engine, recoder).executer();
		else if (e.getSource() == start)
			new Demarrer(recorder).executer();
		else if (e.getSource() == replay)
			new Rejouer(recorder).executer();
		else if (e.getSource() == stop)
			new Arreter(recorder).executer();
		else if (e.getSource() == undo)
			new Defaire(engine).executer();
		else if (e.getSource() == redo)
			new Refaire(engine).executer();
	}

	/**
	 * @see Observateur
	 */
	@Override
	public final void update(Observable o) {

		if (o == null)
			throw new IllegalArgumentException("Null o");

		if (o instanceof Buffer) {

			Buffer buffer = (Buffer) o;

			// On désactive le filtre pour éviter de renvoyer une commande
			modifFilter.setActive(false);
			selectionListener.setActive(false);

			textArea.setText(buffer.getContenu());
			textArea.setCaretPosition(buffer.getOffsetModif());

			selectionListener.setActive(true);
			modifFilter.setActive(true);
		}
	}
}